<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡—é ­æ¼”èª¬ãƒãƒƒãƒ—ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --border: #334155;
            --status-auto: #3b82f6;
            --status-verified: #fbbf24;
            --status-pinpoint: #f87171;
            --success: #10b981;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #map {
            flex: 1;
            min-height: 40%;
            border-bottom: 2px solid var(--border);
        }

        .dashboard {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        h1 {
            font-size: 1.2rem;
            margin: 0;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .last-updated {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .view-toggle,
        .help-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--accent);
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: bold;
            transition: 0.2s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .view-toggle:hover,
        .help-toggle:hover {
            background: var(--accent);
            color: white;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            background: #0f172a;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            outline: none;
        }

        #results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            gap: 10px;
            transition: 0.2s;
        }

        .card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .card-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }

        .card-content {
            flex: 1;
            font-size: 0.85rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }

        .candidate-name {
            font-weight: bold;
            font-size: 0.95rem;
        }

        .date-info {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0f172a;
            border-radius: 4px;
            padding: 4px 8px;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }

        .status-badge {
            font-size: 0.65rem;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        .status-0 {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .status-1 {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status-2 {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .btn-small {
            background: #334155;
            border: none;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-left: 4px;
        }

        .btn-small:hover {
            background: var(--accent);
        }

        .custom-div-icon {
            background: none;
            border: none;
        }

        .marker-pin {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
            border: 2px solid white;
            position: relative;
        }

        .marker-pin:hover {
            transform: scale(1.2);
        }

        /* Dispute Badge */
        .dispute-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .dispute-banner-popup {
            background: #450a0a;
            color: #fca5a5;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-bottom: 8px;
            border-left: 3px solid #ef4444;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 10% auto;
            padding: 20px;
            border: 1px solid var(--border);
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        .guide-banner {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            z-index: 3000;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            font-weight: bold;
            text-align: center;
            min-width: 320px;
        }

        .app-footer {
            text-align: center;
            padding: 1.5rem 0 0.5rem;
            border-top: 1px solid var(--border);
            margin-top: auto;
            background: var(--card-bg);
        }

        .footer-links {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-size: 0.75rem;
        }

        .footer-link {
            color: var(--text-muted);
            text-decoration: none;
        }

        .footer-link:hover {
            color: var(--accent);
        }

        .leaflet-popup-content-wrapper {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 5px;
        }

        .leaflet-popup-tip {
            background: var(--card-bg);
            border: 1px solid var(--border);
        }

        /* Toast Notification */
        #toast {
            display: none;
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            z-index: 5000;
            border: 1px solid var(--accent);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8);
            font-weight: bold;
            transition: opacity 0.3s;
        }

        .toast-show {
            display: block;
            animation: toastIn 0.3s;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                bottom: 0;
            }

            to {
                opacity: 1;
                bottom: 40px;
            }
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <div class="dashboard">
        <div class="header">
            <div>
                <h1>è¡—é ­æ¼”èª¬ãƒãƒƒãƒ—</h1>
                <p class="subtitle">Last updated: 2026-02-01 20:50:00 (JST)</p>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="help-toggle" onclick="openModal('helpModal')">â“ ä½¿ã„æ–¹</button>
                <a href="list.html" class="view-toggle">ğŸ“Š ä¸€è¦§</a>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <input type="text" id="search-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢..." oninput="updateDisplay()">
            </div>
            <div class="filter-group">
                <input type="date" id="date-filter" onchange="updateDisplay()">
            </div>
            <div class="filter-group">
                <select id="pref-filter" onchange="updateDisplay()">
                    <option value="">ã™ã¹ã¦ã®éƒ½é“åºœçœŒ</option>
                </select>
            </div>
            <div class="filter-group">
                <select id="constituency-filter" onchange="updateDisplay()">
                    <option value="">ã™ã¹ã¦ã®é¸æŒ™åŒº</option>
                </select>
            </div>
            <div class="filter-group">
                <select id="candidate-filter" onchange="updateDisplay()">
                    <option value="">ã™ã¹ã¦ã®å€™è£œè€…</option>
                </select>
            </div>
            <div class="filter-group" id="admin-filter" style="display:none; align-items:center;">
                <label style="font-size:0.75rem; color: #ef4444; font-weight:bold; cursor:pointer;">
                    <input type="checkbox" id="dispute-only" onchange="updateDisplay()"> âš ï¸å ±å‘Šã®ã¿è¡¨ç¤º
                </label>
            </div>
        </div>

        <div id="admin-panel"
            style="display:none; background: #334155; padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #fbbf24;">
            <div style="font-size:0.8rem; margin-bottom: 8px; color:#fff;"><strong>ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰:</strong> ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å ±å‘Šã‚’åæ˜ ä¸­ã€‚
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-small" style="background:#fbbf24; color:#000; font-weight:bold; padding:8px 15px;"
                    onclick="exportUpdatedDatabase()">æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’JSONã§å‡ºåŠ›</button>
            </div>
            <div id="export-area" style="display:none; margin-top:10px;">
                <p style="font-size:11px; color:#fbbf24; margin-bottom:5px;"><strong>ğŸ’¡ å®‰å…¨ãªæ›´æ–°æ–¹æ³•:</strong><br>1.
                    ä¸‹ã®JSONã‚’å…¨æ–‡ã‚³ãƒ”ãƒ¼<br>2. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ <code>node scripts/update_db.js</code> ã‚’å®Ÿè¡Œ<br>3.
                    æŒ‡ç¤ºã«å¾“ã£ã¦ãƒšãƒ¼ã‚¹ãƒˆã™ã‚‹ã¨ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¦æ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>
                <textarea id="json-output"
                    style="width:100%; height:120px; background:#000; color:#0f0; font-family:monospace; font-size:10px;"></textarea>
            </div>
        </div>

        <div id="results"></div>

        <footer class="app-footer">
            <div class="footer-links">
                <a href="terms.html" target="_blank" class="footer-link">åˆ©ç”¨è¦ç´„</a>
                <span class="footer-separator">|</span>
                <a href="privacy.html" target="_blank" class="footer-link">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                <span class="footer-separator">|</span>
                <a href="https://lit.link/yamadayuji1990" target="_blank" class="footer-link">ã¤ãã£ãŸäºº</a>
                <span class="footer-separator">|</span>
                <a href="?mode=admin" class="footer-link">é–‹ç™ºè€…ç”¨ãƒšãƒ¼ã‚¸ã¸</a>
            </div>
        </footer>
    </div>

    <!-- Dispute Modal -->
    <div id="disputeModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>ä¸è‡ªç„¶ãªç‚¹ã‚’å ±å‘Š</h3>
                <span style="font-size:24px; cursor:pointer" onclick="closeModal('disputeModal')">âœ•</span>
            </div>
            <div class="modal-body">
                <p id="disputeTarget" style="font-size: 0.8rem; color: var(--text-muted);"></p>
                <select id="disputeReason" onchange="toggleDisputeFields()"
                    style="width:100%; padding:10px; background:#0f172a; color:#fff; border:1px solid #334155; margin-bottom:10px;">
                    <option value="å ´æ‰€ãŒé•ã†">å ´æ‰€ãŒé•ã†</option>
                    <option value="å ´æ‰€ã®å¤‰æ›´">å ´æ‰€ã®å¤‰æ›´</option>
                    <option value="ä¸­æ­¢">ä¸­æ­¢</option>
                    <option value="æ™‚é–“ãŒé•ã†">æ™‚é–“ãŒé•ã†</option>
                    <option value="ãã®ä»–">ãã®ä»–</option>
                </select>

                <!-- For Location Change -->
                <div id="locationChangeFields"
                    style="display:none; background: rgba(59, 130, 246, 0.1); padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--accent);">
                    <p style="font-size: 0.75rem; margin-top: 0;"><strong>å ´æ‰€å¤‰æ›´ã®è©³ç´°:</strong></p>
                    <input type="text" id="newLocationName" placeholder="å¤‰æ›´å…ˆã®åç§° (ä¾‹: ä»Šäº•äº¤å·®ç‚¹)"
                        style="width:100%; padding:8px; margin-bottom:8px; background:#000; border:1px solid #555; color:#fff; font-size:0.8rem;">
                    <div style="display:flex; gap:5px; align-items:center; margin-bottom:8px;">
                        <input type="text" id="newCoords" readonly placeholder="åœ°å›³ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„"
                            style="flex:1; padding:8px; background:#111; border:1px solid #333; color:#aaa; font-size:0.75rem;">
                        <button class="btn-small" style="background:var(--accent); white-space:nowrap;"
                            onclick="startPickingNewLocation()">åœ°å›³ã‹ã‚‰é¸ã¶</button>
                    </div>
                    <input type="hidden" id="newLat">
                    <input type="hidden" id="newLng">
                </div>

                <textarea id="disputeComment"
                    style="width:100%; height:80px; padding:10px; background:#0f172a; color:#fff; border:1px solid #334155; margin-bottom:10px;"
                    placeholder="çŠ¶æ³ãƒ»å¤‰æ›´ç†ç”±ï¼ˆä»»æ„ï¼‰"></textarea>
                <button id="submitDisputeBtn" class="btn-primary" onclick="submitDispute()">å ±å‘Šã‚’é€ä¿¡ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div
                style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom: 2px solid var(--accent); padding-bottom: 10px;">
                <h3 style="margin:0;">ğŸ—º è¡—é ­æ¼”èª¬ãƒãƒƒãƒ—ã®ä½¿ã„æ–¹</h3>
                <span style="font-size:24px; cursor:pointer" onclick="closeModal('helpModal')">âœ•</span>
            </div>
            <div class="modal-body" style="font-size: 0.9rem; line-height: 1.6;">
                <p>ã“ã®ãƒãƒƒãƒ—ã¯ã€è¡—é ­æ¼”èª¬ã®äºˆå®šã‚’ã¿ã‚“ãªã§ç¢ºèªã—ã€æ­£ç¢ºãªå ´æ‰€ã«ä¿®æ­£ã—ã¦ã„ããƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚</p>

                <h4 style="color: var(--accent); margin: 15px 0 5px;">ğŸ“ ãƒ”ãƒ³ã®è‰²ã¨ç²¾åº¦</h4>
                <ul style="padding-left: 20px;">
                    <li><b style="color: var(--status-auto);">â— é’è‰²: è‡ªå‹•æ¨å®š</b><br>AIã‚„ä½æ‰€ã‹ã‚‰å¤§ã¾ã‹ã«é…ç½®ã—ãŸå ´æ‰€ã§ã™ã€‚ç²¾åº¦ã¯ä½ã‚ã§ã™ã€‚</li>
                    <li><b style="color: var(--status-verified);">â— é»„è‰²: ä½æ‰€âœ“æ¸ˆ</b><br>é–²è¦§è€…ãŒã€Œå¤§ä½“ã“ã®å ´æ‰€ã§åˆã£ã¦ã„ã‚‹ã€ã¨ç¢ºèªã—ãŸå ´æ‰€ã§ã™ã€‚</li>
                    <li><b style="color: var(--status-pinpoint);">â— èµ¤è‰²: ç²¾å¯†âœ“æ¸ˆ</b><br>ãƒ”ãƒ³ã‚’é§è»Šå ´ã®å…¥å£ãªã©ã®æ­£ç¢ºãªä½ç½®ã«åˆã‚ã›ãŸå ´æ‰€ã§ã™ã€‚</li>
                </ul>

                <h4 style="color: var(--accent); margin: 15px 0 5px;">ğŸ¤ åœ°å›³ã‚’è‚²ã¦ã‚‹ï¼ˆå”åŠ›ã™ã‚‹æ–¹æ³•ï¼‰</h4>
                <p>ãƒ”ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                <ul style="padding-left: 20px;">
                    <li><b>[å¤§ä½“OK]</b> : å ´æ‰€ãŒåˆã£ã¦ã„ã‚Œã°æŠ¼ã—ã¦ãã ã•ã„ã€‚</li>
                    <li><b>[ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆèª¿æ•´]</b> : ãƒ”ãƒ³ã‚’æ­£ç¢ºãªå ´æ‰€ï¼ˆé§è»Šå ´ã®å…¥å£ãªã©ï¼‰ã¸ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç¢ºå®šã§ãã¾ã™ã€‚</li>
                    <li><b>[ä¸è‡ªç„¶ãƒ»é–“é•ã„å ±å‘Š]</b> : ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å¤‰æ›´ã‚„ã€å ´æ‰€ãŒæ˜ã‚‰ã‹ã«é•ã†å ´åˆã«å ±å‘Šã§ãã¾ã™ã€‚</li>
                </ul>
                <h4 style="color: var(--accent); margin: 15px 0 5px;">ğŸ“¸ è¡—å®£ã‚«ãƒ¼ãƒ‰ã®æä¾›</h4>
                <p>è¡—é ­æ¼”èª¬ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¨˜è¼‰ã•ã‚ŒãŸç”»åƒï¼ˆè¡—å®£ã‚«ãƒ¼ãƒ‰ï¼‰ã‚’ãŠæŒã¡ã®æ–¹ã¯ã€ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã„ãŸã ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ï¼</p>
                <div style="text-align: center; margin: 10px 0;">
                    <a href="https://www.dropbox.com/request/HOt4GT4CNk2zniZ8qjHU" target="_blank" class="btn-primary"
                        style="text-decoration: none; display: inline-block; width: auto; padding: 10px 30px;">
                        ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
                    </a>
                </div>

                <p style="font-size: 0.8rem; background: rgba(59, 130, 246, 0.1); padding: 10px; border-radius: 6px;">
                    â€»çš†æ§˜ã®å ±å‘Šã‚„ç”»åƒæä¾›ã¯ã€åœ°å›³ã®ç²¾åº¦å‘ä¸Šã¨æœ€æ–°æƒ…å ±ã®ç¶­æŒã«å½¹ç«‹ã¦ã‚‰ã‚Œã¾ã™ã€‚</p>
            </div>
            <button class="btn-primary" style="margin-top:15px;" onclick="closeModal('helpModal')">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="editGuide" class="guide-banner">
        ãƒ”ãƒ³ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æ­£ç¢ºãªä½ç½®ã«ç§»å‹•ã•ã›ã¦ãã ã•ã„<br>
        <div style="margin-top:12px; display:flex; justify-content:center; gap:10px;">
            <button class="btn-small"
                style="background:#fff; color:var(--accent); padding:8px 20px; font-weight:bold; font-size:0.8rem;"
                onclick="finishEditing()">ã“ã®ä½ç½®ã§ç¢ºå®š</button>
            <button class="btn-small" style="background:rgba(255,255,255,0.2); padding:8px 20px; font-size:0.8rem;"
                onclick="cancelEditing()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <div id="pickingGuide" class="guide-banner">
        åœ°å›³ä¸Šã®æ–°ã—ã„å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„<br>
        <div style="margin-top:12px; display:flex; justify-content:center; gap:10px;">
            <button class="btn-small" style="background:rgba(255,255,255,0.2); padding:8px 20px; font-size:0.8rem;"
                onclick="stopPickingNewLocation()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <div id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="data/database.js"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwyC7S8oiLvND6Blzowji2koOLG1z7rKxza9sbdMISSfmCGW_EEP9RCNlqvwGDMPLXv/exec";
        let isAdmin = false; // Initial status
        let map;
        let markers = [];
        let editingIndex = null;
        let originalLatLng = null;
        let currentDisputeTarget = null;

        async function checkAdminAuth() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å–å¾—ã‚’ã‚ˆã‚Šç¢ºå®Ÿã«
            const search = window.location.search || (window.location.hash.includes('?') ? window.location.hash.split('?')[1] : '');
            const params = new URLSearchParams(search);
            const mode = params.get('mode');

            console.log("Debug - URL Search string:", search);
            console.log("Debug - Mode Value:", mode);

            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
            if (params.get('logout') === 'true') {
                sessionStorage.removeItem('admin_authenticated');
                console.log("Admin: Logged out successfully.");
            }

            if (mode !== 'admin') {
                console.log("Admin: Mode is not 'admin'. Detected:", mode);
                return false;
            }

            // ã™ã§ã«èªè¨¼æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            if (sessionStorage.getItem('admin_authenticated') === 'true') {
                console.log("Admin: Already authenticated via session.");
                return true;
            }

            console.log("Admin: Requesting password...");
            const password = prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if (!password) {
                console.log("Admin: Password prompt cancelled.");
                return false;
            }

            // å®Ÿè¡Œç’°å¢ƒã®ç¢ºèª (SHA-256ã«ã¯Secure ContextãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™)
            if (!window.crypto || !window.crypto.subtle) {
                alert("ã‚¨ãƒ©ãƒ¼: ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã€ã¾ãŸã¯é€šä¿¡ç’°å¢ƒ(éHTTPSç­‰)ã§ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç…§åˆãŒã§ãã¾ã›ã‚“ã€‚\nlocalhost ã¾ãŸã¯ HTTPS ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚");
                return false;
            }

            // SHA-256ã§ãƒãƒƒã‚·ãƒ¥åŒ–
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

            const EXPECTED_HASH = "e11571c3a4763d1a9c7afbe5b651c4fcb3a59e0091e9af83c3c26aba31fa0a30";

            if (hashHex === EXPECTED_HASH) {
                sessionStorage.setItem('admin_authenticated', 'true');
                console.log("Admin: Auth successful.");
                return true;
            } else {
                console.log("Admin: Password mismatch.");
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
                return false;
            }
        }

        function initMap() {
            map = L.map('map').setView([36.3, 138.1], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        function createMarkerIcon(status, isDisputed = false) {
            let size, color, opacity;
            if (status === 2) { size = 14; color = 'var(--status-pinpoint)'; opacity = 1; }
            else if (status === 1) { size = 20; color = 'var(--status-verified)'; opacity = 0.8; }
            else { size = 28; color = 'var(--status-auto)'; opacity = 0.5; }

            const badgeHtml = isDisputed ? '<div class="dispute-badge">!</div>' : '';

            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="marker-pin" style="width: ${size}px; height: ${size}px; background: ${color}; opacity: ${opacity};">${badgeHtml}</div>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2]
            });
        }

        async function reportToGAS(data) {
            const params = new URLSearchParams(data);
            try {
                await fetch(`${GAS_URL}?${params.toString()}`, { mode: 'no-cors' });
                return true;
            } catch (e) {
                console.error("GAS Report error:", e);
                return false;
            }
        }

        function updateDisplay() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const date = document.getElementById('date-filter').value;
            const pref = document.getElementById('pref-filter').value;
            const consti = document.getElementById('constituency-filter').value;
            const candidate = document.getElementById('candidate-filter').value;
            const disputeOnly = document.getElementById('dispute-only').checked;

            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const filteredData = GAITOU_DB.filter(item => {
                const matchesSearch = item.candidate.toLowerCase().includes(searchTerm) ||
                    item.schedule.some(s => s.location.toLowerCase().includes(searchTerm));
                const matchesDate = !date || item.date === date;
                const matchesPref = !pref || item.prefecture === pref;
                const matchesConsti = !consti || item.constituency === consti;
                const matchesCandidate = !candidate || item.candidate === candidate;

                // For checking disputes across schedules within an item
                const hasDispute = item.schedule.some(s => s.dispute);
                const matchesDispute = !disputeOnly || hasDispute;

                return matchesSearch && matchesDate && matchesPref && matchesConsti && matchesCandidate && matchesDispute;
            });

            // æœ€æ–°ã®æ—¥ä»˜ã‹ã‚‰é™é †ã«ä¸¦ã³æ›¿ãˆ
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));

            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';
            const bounds = L.latLngBounds();

            filteredData.forEach(item => {
                let scheduleHtml = '';
                let hasVisibleSchedules = false;

                item.schedule.forEach(s => {
                    // Filter at schedule level if disputeOnly is checked
                    if (disputeOnly && !s.dispute) return;

                    hasVisibleSchedules = true;
                    const hasCoords = (s.lat && s.lng && !isNaN(s.lat) && !isNaN(s.lng));
                    const statusLabels = ["è‡ªå‹•æ¨å®š", "ä½æ‰€âœ“æ¸ˆ", "ç²¾å¯†âœ“æ¸ˆ"];
                    const statusClass = `status-${s.status}`;
                    const currentIndex = markers.length;

                    // åº§æ¨™ãŒã‚ã‚‹å ´åˆã®ã¿ã€Œä½ç½®ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    const locationBtn = hasCoords ? `<button class="btn-small" onclick="focusOn(${s.lat}, ${s.lng})">ä½ç½®</button>` : `<span style="font-size:0.7rem; color:var(--text-muted); margin-left:8px;">(è©³ç´°æœªè©³)</span>`;

                    scheduleHtml += `
                        <div class="schedule-item">
                            <span>${s.time} ${s.location}</span>
                            <div>
                                <span class="status-badge ${statusClass}">${statusLabels[s.status]}</span>
                                ${locationBtn}
                            </div>
                        </div>
                    `;
                    // ... (marker creation stays same but needs to use currentIndex correctly)

                    let actionButtonsHtml = '';
                    if (s.status === 0) {
                        actionButtonsHtml = `
                            <button onclick="quickVerify(${currentIndex})" class="btn-small" style="background:var(--success); color:white; padding:8px; font-weight:bold; margin:0;">å¤§ä½“OK</button>
                            <button onclick="startEditingMarker(${currentIndex})" class="btn-small" style="background:var(--status-verified); color:#000; padding:8px; font-weight:bold; margin:0;">ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆèª¿æ•´</button>
                        `;
                    } else if (s.status === 1) {
                        actionButtonsHtml = `
                            <button onclick="startEditingMarker(${currentIndex})" class="btn-small" style="background:var(--status-verified); color:#000; padding:8px; font-weight:bold; margin:0;">ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆèª¿æ•´</button>
                        `;
                    }

                    const disputeHtml = s.dispute ? `
                        <div class="dispute-banner-popup">
                            <strong>âš ï¸ å ±å‘Šã‚ã‚Š</strong><br>
                            ${s.dispute}
                        </div>
                    ` : '';

                    let adminActionsHtml = '';
                    if (isAdmin && s.dispute) {
                        adminActionsHtml = `
                            <div style="background:var(--border); padding:8px; border-radius:4px; margin-top:10px;">
                                <div style="font-size:0.7rem; font-weight:bold; margin-bottom:5px;">ç®¡ç†è€…ç”¨ï¼šç•°è­°ã®è§£æ±º</div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:4px;">
                                    <button onclick="resolveDispute('${item.id}', '${s.time}', 0)" class="btn-small" style="background:#444;">æ¨å®šã¸æˆ»ã™</button>
                                    <button onclick="resolveDispute('${item.id}', '${s.time}', 1)" class="btn-small" style="background:#444;">ä½æ‰€OKã¸</button>
                                    <button onclick="resolveDispute('${item.id}', '${s.time}', 2)" class="btn-small" style="background:#444;">ç²¾å¯†OKã¸</button>
                                    <button onclick="startEditingMarker(${currentIndex})" class="btn-small" style="background:var(--accent);">ä½ç½®ä¿®æ­£</button>
                                </div>
                            </div>
                        `;
                    }

                    if (hasCoords) {
                        const marker = L.marker([s.lat, s.lng], {
                            icon: createMarkerIcon(s.status, (isAdmin && !!s.dispute)),
                            data: { id: item.id, candidate: item.candidate, location: s.location, time: s.time, lat: s.lat, lng: s.lng }
                        }).bindPopup(`
                            <div style="font-family: sans-serif; min-width: 220px; color: var(--text); padding:5px;">
                                ${disputeHtml}
                                <strong style="color:var(--accent); font-size:1.1rem;">${item.candidate}</strong><br>
                                <span style="font-size:0.9rem;">${item.date} ${s.time}</span><br>
                                <span style="font-size:0.9rem;">${s.location}</span><br>
                                <span class="status-badge ${statusClass}" style="margin:5px 0; display:inline-block;">${statusLabels[s.status]}</span>
                                
                                <div style="margin-top:12px; border-top:1px solid var(--border); padding-top:10px; display:flex; flex-direction:column; gap:8px;">
                                    ${actionButtonsHtml}
                                    <button onclick="openDisputeModal('${item.id}', '${item.candidate}', '${s.location}', '${s.time}')" class="btn-small" style="background:#666; padding:8px; margin:0;">ä¸è‡ªç„¶ãƒ»é–“é•ã„å ±å‘Š</button>
                                    ${adminActionsHtml}
                                </div>
                            </div>
                        `);
                        marker.addTo(map);
                        markers.push(marker);
                        bounds.extend([s.lat, s.lng]);
                    }
                });

                if (hasVisibleSchedules) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div style="display:flex; gap:10px; width:100%;">
                            <img src="${item.image_path}" class="card-img" onclick="window.open('${item.image_path}')">
                            <div class="card-content">
                                <div class="card-header">
                                    <span class="candidate-name">${item.candidate}</span>
                                    <span class="date-info">${item.date} (${item.day_of_week})</span>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">${item.prefecture} / ${item.constituency}</div>
                                ${scheduleHtml}
                            </div>
                        </div>
                    `;
                    resultsContainer.appendChild(card);
                }
            });

            if (markers.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
        }

        async function quickVerify(index) {
            const marker = markers[index];
            if (!marker) return;
            const data = marker.options.data;

            await reportToGAS({
                id: data.id,
                candidate: data.candidate,
                location: data.location + " (" + data.time + ")",
                action: "ä½æ‰€ç¢ºèª",
                detail: "OK"
            });

            marker.setIcon(createMarkerIcon(1));
            marker.closePopup();
            alert("ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ä½æ‰€ç¢ºèªã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚");
        }

        function startEditingMarker(index) {
            if (!confirm("ãƒ”ãƒ³ã®å¾®èª¿æ•´ã‚’é–‹å§‹ã—ã¾ã™ã€‚é€ä¿¡ã™ã‚‹ã¾ã§å…ƒã®ä½ç½®ã«ã¯æ‰‹å‹•ã§æˆ»ã›ãªããªã‚Šã¾ã™ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ç›´ã—ã¯å¿…è¦ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

            editingIndex = index;
            const marker = markers[index];
            originalLatLng = marker.getLatLng();
            marker.dragging.enable();
            marker.closePopup();
            document.getElementById('editGuide').style.display = 'block';
            map.flyTo(marker.getLatLng(), 18);
        }

        async function finishEditing() {
            if (editingIndex === null) return;
            const marker = markers[editingIndex];
            const newPos = marker.getLatLng();
            const data = marker.options.data;

            await reportToGAS({
                id: data.id,
                candidate: data.candidate,
                location: data.location + " (" + data.time + ")",
                action: "ç²¾å¯†ç‰¹å®š",
                detail: `${newPos.lat}, ${newPos.lng}`
            });

            marker.setIcon(createMarkerIcon(2));
            marker.dragging.disable();

            // Show toast message
            showToast("å ±å‘Šã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼åæ˜ ã«ã¯ã€Œå†èª­ã¿è¾¼ã¿ã€ãŒå¿…è¦ã§ã™ã€‚");

            // To prevent the pin from jumping back during this session
            originalLatLng = newPos;
            cancelEditing();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            t.classList.add('fade-in');
            setTimeout(() => { t.style.display = 'none'; }, 5000);
        }

        function cancelEditing() {
            if (editingIndex !== null) {
                markers[editingIndex].setLatLng(originalLatLng);
                markers[editingIndex].dragging.disable();
            }
            editingIndex = null;
            document.getElementById('editGuide').style.display = 'none';
        }

        function openDisputeModal(id, candidate, location, time) {
            currentDisputeTarget = { id, candidate, location, time };
            document.getElementById('disputeTarget').textContent = `å¯¾è±¡: ${candidate} - ${location} (${time})`;
            document.getElementById('disputeModal').style.display = 'block';
            resetDisputeModal();
        }

        function resetDisputeModal() {
            document.getElementById('disputeReason').value = "å ´æ‰€ãŒé•ã†";
            document.getElementById('locationChangeFields').style.display = 'none';
            document.getElementById('newLocationName').value = "";
            document.getElementById('newCoords').value = "";
            document.getElementById('newLat').value = "";
            document.getElementById('newLng').value = "";
            document.getElementById('disputeComment').value = "";
        }

        function toggleDisputeFields() {
            const reason = document.getElementById('disputeReason').value;
            document.getElementById('locationChangeFields').style.display = (reason === "å ´æ‰€ã®å¤‰æ›´") ? 'block' : 'none';
        }

        let isPickingLocation = false;
        function startPickingNewLocation() {
            isPickingLocation = true;
            document.getElementById('disputeModal').style.display = 'none';
            document.getElementById('pickingGuide').style.display = 'block';
            map.getContainer().style.cursor = 'crosshair';

            map.once('click', (e) => {
                if (!isPickingLocation) return;
                const { lat, lng } = e.latlng;
                document.getElementById('newLat').value = lat;
                document.getElementById('newLng').value = lng;
                document.getElementById('newCoords').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                stopPickingNewLocation();
                document.getElementById('disputeModal').style.display = 'block';
            });
        }

        function stopPickingNewLocation() {
            isPickingLocation = false;
            document.getElementById('pickingGuide').style.display = 'none';
            map.getContainer().style.cursor = '';
        }

        function openModal(id) { document.getElementById(id).style.display = 'block'; }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        async function submitDispute() {
            if (!currentDisputeTarget) return;
            const reason = document.getElementById('disputeReason').value;
            let detail = `ç†ç”±: ${reason}`;

            if (reason === "å ´æ‰€ã®å¤‰æ›´") {
                const newName = document.getElementById('newLocationName').value;
                const lat = document.getElementById('newLat').value;
                const lng = document.getElementById('newLng').value;
                if (!newName || !lat) {
                    alert("å¤‰æ›´å…ˆã®åç§°ã¨å ´æ‰€ã‚’åœ°å›³ã‹ã‚‰æŒ‡å®šã—ã¦ãã ã•ã„");
                    return;
                }
                detail = `[CHANGE] ${newName} @ ${lat},${lng}`;
            }

            const comment = document.getElementById('disputeComment').value;
            if (comment) detail += ` / ã‚³ãƒ¡ãƒ³ãƒˆ: ${comment}`;

            await reportToGAS({
                id: currentDisputeTarget.id,
                candidate: currentDisputeTarget.candidate,
                location: currentDisputeTarget.location + " (" + currentDisputeTarget.time + ")",
                action: "ç•°è­°ç”³ã—ç«‹ã¦",
                detail: detail
            });

            alert("å ±å‘Šã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ãŒç¢ºèªã„ãŸã—ã¾ã™ã€‚");
            closeModal('disputeModal');
            currentDisputeTarget = null;
        }

        function resolveDispute(id, time, newStatus) {
            const item = GAITOU_DB.find(d => d.id === String(id));
            if (item) {
                const schedule = item.schedule.find(s => s.time === time);
                if (schedule) {
                    // Specific logic for approval of location change
                    if (schedule.dispute && schedule.dispute.startsWith("[CHANGE]")) {
                        const match = schedule.dispute.match(/\[CHANGE\] (.*?) @ (.*?),(.*?)(?: \/ |$)/);
                        if (match && newStatus >= 1) { // If approved as verified or pinpoint
                            const newName = match[1];
                            const lat = parseFloat(match[2]);
                            const lng = parseFloat(match[3]);

                            if (!schedule.location.includes("ã‹ã‚‰å¤‰æ›´")) {
                                schedule.location = `${newName}ï¼ˆ${schedule.location}ã‹ã‚‰å¤‰æ›´ï¼‰`;
                            } else {
                                schedule.location = newName;
                            }
                            schedule.lat = lat;
                            schedule.lng = lng;
                        }
                    }

                    schedule.status = newStatus;
                    delete schedule.dispute;
                    updateDisplay();
                    alert("æ›´æ–°ã—ã¾ã—ãŸã€‚ã€Œæ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’JSONã§å‡ºåŠ›ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
                }
            }
        }

        async function syncFromGas() {
            if (isAdmin) {
                document.getElementById('admin-filter').style.display = 'flex';
                document.getElementById('admin-panel').style.display = 'block';
            }

            try {
                const response = await fetch(`${GAS_URL}?read=true`);
                const logs = await response.json();

                logs.forEach(log => {
                    const [ts, id, cand, loc, action, detail] = log;
                    if (!id) return;

                    const item = GAITOU_DB.find(d => d.id === String(id));
                    if (item) {
                        const timeInLoc = loc.match(/\((.*?)\)/)?.[1];
                        const schedule = item.schedule.find(s => s.time === timeInLoc);

                        if (schedule) {
                            if (action === "ä½æ‰€ç¢ºèª") {
                                schedule.status = Math.max(schedule.status, 1);
                            } else if (action === "ç²¾å¯†ç‰¹å®š") {
                                const coords = detail.split(',').map(s => parseFloat(s.trim()));
                                if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                                    schedule.lat = coords[0];
                                    schedule.lng = coords[1];
                                    schedule.status = 2;
                                }
                            } else if (action === "ç•°è­°ç”³ã—ç«‹ã¦" && isAdmin) {
                                schedule.dispute = detail;
                            }
                        }
                    }
                });
                console.log("Admin: Live reports loaded.");
            } catch (e) {
                console.warn("No sync data.");
            }
        }

        function exportUpdatedDatabase() {
            // Clean up temporary dispute data before export if needed
            const dataToExport = GAITOU_DB.map(item => {
                const itemCopy = JSON.parse(JSON.stringify(item));
                // Optional: keep processed location names but clear dispute text
                itemCopy.schedule.forEach(s => delete s.dispute);
                return itemCopy;
            });

            const jsonText = JSON.stringify(dataToExport, null, 4);
            document.getElementById('export-area').style.display = 'block';
            document.getElementById('json-output').value = jsonText;
            document.getElementById('json-output').select();
            alert("ç¾åœ¨ã®çŠ¶æ…‹ã‚’JSONã§æ›¸ãå‡ºã—ã¾ã—ãŸã€‚ã“ã‚Œã‚’ database.json ã«ã‚³ãƒ”ãƒ¼ã—ã¦ä¸Šæ›¸ãã—ã¦ãã ã•ã„ã€‚");
        }

        function focusOn(lat, lng) { map.flyTo([lat, lng], 17); }

        function initFilters() {
            const prefs = new Set(), constis = new Set(), candidates = new Set();
            GAITOU_DB.forEach(item => { prefs.add(item.prefecture); constis.add(item.constituency); candidates.add(item.candidate); });
            populateSelect('pref-filter', Array.from(prefs).sort());
            populateSelect('constituency-filter', Array.from(constis).sort());
            populateSelect('candidate-filter', Array.from(candidates).sort());
        }

        function populateSelect(id, items) {
            const select = document.getElementById(id);
            items.forEach(item => { const opt = document.createElement('option'); opt.value = item; opt.textContent = item; select.appendChild(opt); });
        }

        window.onload = async () => {
            console.log("App starting...");
            isAdmin = await checkAdminAuth();

            const params = new URLSearchParams(window.location.search);
            if (params.get('mode') === 'admin' && !isAdmin) {
                console.log("Admin: Auth failed or cancelled. Redirecting to normal mode...");
                window.history.replaceState({}, '', window.location.pathname);
            }

            if (isAdmin) {
                console.log("Admin mode enabled.");
            }

            initMap();
            initFilters();
            await syncFromGas();
            updateDisplay();
        };
    </script>
</body>

</html>